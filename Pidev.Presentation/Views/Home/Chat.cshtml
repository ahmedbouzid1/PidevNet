@using Pidev.Presentation.Models
@{

    User userc = Session["userConnected"] as User;

   
}



<br />
<h3 class="card-title">Chat Room</h3>
<br />
<section class="content">
    <div class="container-fluid">

        <div class="row">
            <div class="col-md-12">

                <div class="card direct-chat direct-chat-warning">
                    <div class="card-header">


                        <h3 class="card-title">
                            @{ string path = "~/content/Uploads/" + @userc.ImageUrl;}


                            <img class="direct-chat-img" src="@Url.Content(path)" alt="message user image" />

                            @userc.prenom
                            @userc.nom

                        </h3>
                    </div>
                    <div class="card-body">

                        <div class="direct-chat-messages" >


                            <div class="chat-panel panel panel-default">


                                <div class="panel-body" id="chat" style="height:250px;">
                                    <input type="hidden" id="displayname" value="@userc.nom @userc.prenom" />

                                    <p id="discussion"></p>
                                </div>

                            </div>

                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input id="message" type="text" name="message" class="form-control input-sm" placeholder="Type your message here..." />

                            <span class="input-group-btn">
                                <input type="button" class="btn btn-warning" id="sendmessage" value="Send">

                            </span>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</section>

@section scripts {

    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {



                    @*@{ string path = "~/content/Uploads/" + userc.ImageUrl;}
                           

            <img class="direct-chat-img" src="@Url.Content(path)" alt="message user image" />*@

            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message, dt, image) {

                 
                          

                 

                if (name !="@userc.nom @userc.prenom") {
                    $('#discussion').append('<div class="direct-chat-msg">'+
                        '<div class="direct-chat-info clearfix">'+
                          '<span class="direct-chat-name float-left">'+ htmlEncode(name) +'</span>'+
                          '<span class="direct-chat-timestamp float-right">'+ htmlEncode(dt)+'</span>'+
                        '</div>'+
                        '<img class="direct-chat-img" src="'+ htmlEncode(image) +'" alt="message user image">'+
                        '<div class="direct-chat-text">'+ htmlEncode(message) +
                        '</div>'+
                      '</div>');
                }
                else if (name == "@userc.nom @userc.prenom") {

                    $('#discussion').append('<div class="direct-chat-msg right">'+
                        '<div class="direct-chat-info clearfix">'+
                          '<span class="direct-chat-name float-right">'+ "@userc.prenom  @userc.nom" +'</span>'+
                          '<span class="direct-chat-timestamp float-left">'+  htmlEncode(dt)  +'</span>'+
                        '</div>'+
                        '<img class="direct-chat-img" src="/content/Uploads/'+"@userc.ImageUrl"+'" alt="message user image">'+
                        '<div class="direct-chat-text">'+    htmlEncode(message)  +   '</div></div>');
                }
            };


            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                   chat.server.send($('#displayname').val(), $('#message').val(),"@userc.ImageUrl");
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}


